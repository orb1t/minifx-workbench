<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainPane.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">minifx-workbench</a> &gt; <a href="index.source.html" class="el_package">org.minifx.workbench.components</a> &gt; <span class="el_source">MainPane.java</span></div><h1>MainPane.java</h1><pre class="source lang-java linenums">/**
 * Copyright (c) 2016 European Organisation for Nuclear Research (CERN), All Rights Reserved.
 */

package org.minifx.workbench.components;

import javafx.application.Platform;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.control.ToggleButton;
import javafx.scene.control.ToggleGroup;
import javafx.scene.control.ToolBar;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Priority;
import org.minifx.workbench.css.MiniFxCssConstants;
import org.minifx.workbench.domain.definition.DisplayProperties;
import org.minifx.workbench.domain.definition.FooterDefinition;
import org.minifx.workbench.domain.definition.PerspectiveDefinition;
import org.minifx.workbench.nodes.FxNodeFactory;
import org.minifx.workbench.spring.AbstractPerspectiveEvent;
import org.minifx.workbench.spring.ActivatePerspectiveCommand;
import org.minifx.workbench.spring.ChangePerspectiveButtonStyleCommand;
import org.minifx.workbench.spring.PerspectiveActivatedEvent;
import org.minifx.workbench.util.MiniFxComponents;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.context.event.EventListener;

import java.util.Collection;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

import static com.google.common.collect.ImmutableList.copyOf;
import static java.util.Collections.singletonList;
import static org.minifx.workbench.css.MiniFxCssConstants.PERSPECTIVE_BUTTON_CLASS;
import static org.minifx.workbench.css.MiniFxCssConstants.TOOLBAR_BUTTON_CLASS;
import static org.minifx.workbench.util.MiniFxComponents.containerPaneFrom;
import static org.minifx.workbench.util.MiniFxComponents.createPerspective;

/**
 * Main JavaFX Pane for a MiniFx application. It has a toolbar for perspective switching at the top. The active
 * perspective is integrated in the center.
 */
public class MainPane extends BorderPane {

<span class="fc" id="L50">    private static final HBox DEFAULT_FILLER = new HBox();</span>

<span class="fc" id="L52">    private final Map&lt;Object, Node&gt; perspectives = new HashMap&lt;&gt;();</span>
<span class="fc" id="L53">    private final Map&lt;Object, ToggleButton&gt; perspectivesToButtons = new HashMap&lt;&gt;();</span>

    private final ApplicationEventPublisher publisher;
    private HBox perspectiveButtonsBox;
<span class="fc" id="L57">    private ToggleGroup perspectiveButtonToggleGroup = new ToggleGroup();</span>

    public MainPane(Iterable&lt;Object&gt; toolbarItems, ApplicationEventPublisher publisher, FxNodeFactory fxNodeFactory) {
<span class="fc" id="L60">        this(toolbarItems, DEFAULT_FILLER, publisher, fxNodeFactory);</span>
<span class="fc" id="L61">    }</span>

    public MainPane(Iterable&lt;Object&gt; toolbarItems, Node filler, ApplicationEventPublisher publisher,
<span class="fc" id="L64">            FxNodeFactory fxNodeFactory) {</span>
<span class="fc" id="L65">        this.publisher = publisher;</span>
<span class="fc" id="L66">        List&lt;Node&gt; toolbarNodes = fxNodeFactory.fxNodesFrom(copyOf(toolbarItems));</span>

<span class="fc" id="L68">        HBox toolbarBox = horizontalBoxOf(Pos.TOP_LEFT);</span>
<span class="fc" id="L69">        HBox centralBox = horizontalBoxOf(Pos.TOP_CENTER);</span>
<span class="fc" id="L70">        perspectiveButtonsBox = horizontalBoxOf(Pos.TOP_RIGHT);</span>

<span class="fc" id="L72">        addToolbarButtonsTo(toolbarNodes, toolbarBox);</span>
<span class="fc" id="L73">        addToolbarButtonsTo(singletonList(filler), centralBox);</span>

<span class="fc" id="L75">        HBox.setHgrow(centralBox, Priority.ALWAYS);</span>

<span class="fc" id="L77">        setTop(new ToolBar(toolbarBox, centralBox, perspectiveButtonsBox));</span>
<span class="fc" id="L78">    }</span>

    /**
     * Set the {@link FooterDefinition}s that will be added to the pane. NOTE: this method can be called only once
     * in the current implementation!
     */
    public void setFooters(Collection&lt;FooterDefinition&gt; footers) {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">        if (getBottom() != null) {</span>
            /* A refactor of MiniFxComponents#containerPaneFrom would allow dynamic insertions of footer items */
<span class="nc" id="L87">            throw new IllegalStateException(&quot;Footer already initialized!&quot;);</span>
        }

<span class="fc" id="L90">        Platform.runLater(() -&gt; containerPaneFrom(footers).map(MiniFxComponents::configureSingleNodeStyle).ifPresent(this::setBottom));</span>
<span class="fc" id="L91">    }</span>

    /**
     * Add {@link PerspectiveDefinition}s to the pane. NOTE: this method can be called only once in the current
     * implementation!
     */
    public void setPerspectives(Collection&lt;PerspectiveDefinition&gt; definitions) {
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        if (definitions.isEmpty()) {</span>
<span class="fc" id="L99">            return;</span>
        }

<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (!perspectives.isEmpty()) {</span>
<span class="nc" id="L103">            throw new IllegalStateException(&quot;Perspectives already initialized!&quot;);</span>
        }

<span class="nc" id="L106">        definitions.forEach(definition -&gt; perspectives.put(definition.perspective(), createPerspective(definition)));</span>

<span class="nc" id="L108">        List&lt;ToggleButton&gt; orderedPerspectiveButtons = definitions.stream() //</span>
<span class="nc" id="L109">                .sorted(Comparator.comparingInt(p -&gt; p.displayProperties().order())) //</span>
<span class="nc" id="L110">                .map(this::createPerspectiveButton) //</span>
<span class="nc" id="L111">                .collect(Collectors.toList());</span>

<span class="nc" id="L113">        addToolbarButtonsTo(orderedPerspectiveButtons, perspectiveButtonsBox);</span>
<span class="nc" id="L114">    }</span>

    private static HBox horizontalBoxOf(Pos alignment) {
<span class="fc" id="L117">        HBox box = new HBox();</span>
<span class="fc" id="L118">        box.setSpacing(3);</span>
<span class="fc" id="L119">        box.setAlignment(alignment);</span>
<span class="fc" id="L120">        box.setFillHeight(true);</span>
<span class="fc" id="L121">        return box;</span>
    }

    private static void addToolbarButtonsTo(List&lt;? extends Node&gt; nodes, HBox box) {
<span class="fc" id="L125">        nodes.forEach(node -&gt; node.getStyleClass().add(TOOLBAR_BUTTON_CLASS));</span>
<span class="fc" id="L126">        box.getChildren().addAll(nodes);</span>
<span class="fc" id="L127">    }</span>

    private ToggleButton createPerspectiveButton(PerspectiveDefinition perspective) {
<span class="nc" id="L130">        DisplayProperties displayProperties = perspective.displayProperties();</span>
<span class="nc" id="L131">        ToggleButton button = new ToggleButton(displayProperties.name(), displayProperties.graphic().orElse(null));</span>
<span class="nc" id="L132">        button.setGraphicTextGap(10);</span>
<span class="nc" id="L133">        button.setOnAction(evt -&gt; setActive(perspective.perspective()));</span>
<span class="nc" id="L134">        button.getStyleClass().addAll(PERSPECTIVE_BUTTON_CLASS, TOOLBAR_BUTTON_CLASS);</span>

<span class="nc" id="L136">        perspectivesToButtons.put(perspective.perspective(), button);</span>
<span class="nc" id="L137">        perspectiveButtonToggleGroup.getToggles().add(button);</span>
<span class="nc" id="L138">        return button;</span>
    }

    private void setActive(Object perspectiveDefinition) {
<span class="nc" id="L142">        Node perspective = this.perspectives.get(perspectiveDefinition);</span>
<span class="nc" id="L143">        perspective.getStyleClass().add(MiniFxCssConstants.MAIN_PANE_CLASS);</span>
<span class="nc" id="L144">        setCenter(perspective);</span>
<span class="nc" id="L145">        publisher.publishEvent(new PerspectiveActivatedEvent(perspectiveDefinition));</span>
<span class="nc" id="L146">    }</span>

    private Optional&lt;ToggleButton&gt; perspectiveButton(AbstractPerspectiveEvent command) {
<span class="nc" id="L149">        return Optional.of(this.perspectivesToButtons.get(command.perspective()));</span>
    }

    @EventListener
    public void activatePerspective(ActivatePerspectiveCommand command) {
<span class="nc" id="L154">        Platform.runLater(() -&gt; perspectiveButton(command).ifPresent(ToggleButton::fire));</span>
<span class="nc" id="L155">    }</span>

    @EventListener
    public void colorPerspectiveButton(ChangePerspectiveButtonStyleCommand command) {
<span class="nc" id="L159">        Platform.runLater(() -&gt; perspectiveButton(command).map(b -&gt; b.getStyleClass()).ifPresent(command::apply));</span>
<span class="nc" id="L160">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>